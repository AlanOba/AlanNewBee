##商品管理面试题答案

###1.你能解释一下，什么是SKU和SPU吗？

SPU是商品公共信息，SKU是商品的规格信息。比如说一个小米手机，SPU信息是安卓系统，高通的CPU，6.5寸的屏幕，4000毫安的电池等等。但是这部手机的内存容量和颜色是有很多种规格的，假设有3种容量和3种颜色，组合在一起，就是9种规格方案，也就是9条sku信息。我们创建时数据表的时候，SPU表和SKU表是一对多的关系，一个SPU记录，对应多条SKU记录

###2.如果删除一条SPU记录，那么它对应的SKU记录应该怎么处理？

如果是物理删除，删除SPU之前，要先判断SPU记录有没有关联的订单？如果有关联的订单，那么SPU记录是不能删除的。如果没有关联的订单，是可以删除SPU记录的。但是删除SPU记录，要连带着删除SKU记录。这是物理删除的情况。如果是逻辑删除，那么不需要判断SPU是否存在关联的订单，直接在SPU记录的deleted字段设置上true，就代表这条记录已经删除了。包括关联的SKU记录，deleted字段也设置上true就行了

###3.你做的电商系统是单商铺的还是多商铺的？

你可以这样回答：我做的电商项目是B2C模式的，也就是单商铺的模式。如果要做多商铺的C2C电商系统，那么商铺之间的数据要隔离，不能交叉访问。所以设计数据表的时候要引入商铺表，然后让SPU关联到商铺ID，这样每个商铺就只能看到自己的数据了。

###4.如何避免客户投诉的时候，商家随意篡改信息？

虽然我们做的是单商铺的电商系统，只要商家编辑商品，都要形成一条新的商品记录，当用户根据订单查询商品的时候，并不会看到最新的商品记录，而是会查询到他下单时候的商品记录，这就防止了商家随意篡改订单商品信息。因为我们现在做的是单商铺的电商网站，所以一个商家的商品记录包括归档的数据，还形不成上千万的数据规模。如果做成多商铺的电商系统，那么SKU表和SKU表保存大量的归档数据。因为单表超过了两千万记录，MySQL的读写性能会很差。所以这种情况下，应该单独创建SPU和SKU的归档表，把归档的数据转移存储到归档表里面，这样就能实现对SKU和SPU数据表的缩表，这种数据库设计叫做冷热数据分离。

###5.删除商品记录，你们用的是逻辑删除，还是物理删除？

我们用逻辑删除，而不是物理删除。
###6.怎么提高商品信息的加载速度？

很明显面试官假设了一个场景，然后考察你的设计能力，第三轮和第四轮面试中，经常会遇到这样的问题。提高前端页面加载速度，其实前后端都存在着大量的优化方案。所以这道题，想要考察的是求职者的思路开阔程度。那么这道题你可以这样回答：

我觉得提高前端渲染的速度有很多优化的方案，首先数据库方面，要做好优化，比如说优化SQL语句，多利用索引，设置innodb缓冲池，增加数据库的线程数量。再有呢，数据库连接池方面，需要增加连接数量。如果是小型项目，我们可以采用MySQL分区，把数据切分存储到不同的硬盘上面，多块硬盘的IO能力要好于单块硬盘，所以MySQL读写速度就提升了。如果是大型项目，数据库层面要使用集群，数据要做分库分表，还要做读写分离，冷热数据分离等等。（推荐收看《MySQL数据库集群-PXC方案》这门课程的5-8小节： 大数据归档-冷热数据分离 ）

其次，在后台程序部分，也能做很多提升数据读取速度的改进，比如说引入缓存，把热点的业务数据缓存到Redis里面。如果命中缓存的话，就不用走数据库了，所以读取速度就提升了。还有就是，后台项目的网络连接方式可以从BIO该成NIO，这样依靠少量的线程就能处理更多的网络请求。还有就是增加Tomcat线程数量，也能实现更大的网络吞吐能力。如果有条件的话，我们可以对Tomcat做负载均衡，也能增加后台项目的负载能力。

另外，我可以利用CDN服务，缓存静态的网页和图片，这样浏览器加载商品信息的时候会快一些。

前端方面也有一些优化的手段，比如说减少Http请求，能合并的请求就合并成一个Http请求。素材图片可以使用雪花图，商品图片可以使用延迟加载的办法。

###7.你的电商系统是否支持顾客根据参数查找商品？

这个问题很有技术水平，我们先来看一下sku记录，比如说床垫吧，有这么多种规格，而且这个字段的类型是JSON数组，JSON类型字段即便设置了索引，那么查找的效率也不是很高，所以用户想要按照规格参数去查找数据，MySQL的执行效率并不是很高。于是乎我们要引入新的技术来应对，这里我推荐使用Elasticsearch，简称为ES，它是一个全文搜索引擎，最适合从海量数据中快速提取我们想要的数据。

我做的电商项目，支持用户按照参数去查找商品，录入商品之后，我们会把商品数据保存到数据库的SPU和SKU数据表里面，然后把可以用来检索的参数和商品名称，以及主键值写到ES里面。用户检索商品的时候，我们就到ES中查找，得到商品的ID，然后从数据库中提取商品的信息，最后渲染到页面上面。

###8.既然用了ES技术，那么SKU表还有什么意义？

ES不能替代SKU表，ES用来检索数据，但是里面并不是存放了一个商品的全部数据，只是用来被检索的那些属性信息，存放在ES里面。页面渲染的时候，详细规格信息还是要从SKU表里面读取的。

###9.如果用户查询“最好看的全面屏手机”，你怎么实现？

这道题又是跟ES技术相关，全文检索里面的中文分词可以实现语义分析。就拿最好看的全面屏手机来说吧，没有任何商品叫这个名字，所以我们要用中文分词技术，提取其中的名词，忽略形容词，于是中文分词之后的结果就是全面屏手机，我们按照这个关键字到ES中检索，就能得到搜索的结果了。

我们给ES添加了中文分词技术，提取搜索信息里面的名词，然后忽略形容词。用户搜索最好看的全面屏手机的时候，最终是按照全面屏手机这个关键字，检索商品的。

###10.存放商品图片，你用的是什么图床？

我们用的是腾讯云的对象存储服务。开通对象存储服务之后，我们在微商城的后台，配置上secretId和secretKey，还有AP和存储桶的信息，通过腾讯云的API接口，就能把图片上传到云端了。我们利用对象存储服务来充当图床服务器的

##秒杀相关面试题答案
###1.如果让你设计一个秒杀系统，你会怎么设计？

秒杀活动通常时间短，并发访问高。如果跟原网站部署在一起，可能会让原网站瘫痪。所以我会单独部署秒杀程序，分配独立的域名。

秒杀之前，为了不错过秒杀活动，用户会频繁刷新页面，这对后台系统造成很大的负载。所以在使用数据库集群、Redis集群，以及负载均衡之外，秒杀页面要实现静态化，避免后台系统渲染动态页面消耗资源。

秒杀的时候，需要短时间增大网络带宽，一方面可以在云端租用临时的带宽资源。另一方面，可以把秒杀页面放在CDN上面，这样可以节省秒杀服务器的带宽。

为了避免秒杀之前，用户提前获取下单页面的URL，所以需要对下单页面的URL实现动态化。例如秒杀开始之后，服务端生成特殊规则的随机数，然后保存到Redis上面，秒杀的时候URL必须带上这样的随机数才能进入到下单画面，这就能避免秒杀之前提前下单的问题。如果秒杀没有开始，任何人都不能进入下单画面。

再有就是秒杀的倒计时也需要特殊设计，秒杀开始之前，CDN上面的JS文件的功能是先获取北京时间，然后在HTML页面上面生成倒计时程序，直到秒杀开始的时候，刷新页面重新加载JS文件。也就是在秒杀开始的那一刻，后台程序在CDN上面更新了JS文件内容。秒杀开始的时候，用户浏览器自动刷新，就能加载到这个最新的JS文件。于是JS文件生成秒杀按钮。用户点击按钮之后，JS就向后台程序发出秒杀请求。可以这么说，在秒杀之前，任何顾客都不能发起秒杀请求。

再有就是减库存的方式，也要合理的设计。目前有两种扣减库存的方案，第一种是付款之后才扣减库存，但是会出现问题。比如说iphone手机有100部库存，但是秒杀的时候有2000人成功下单，然后有100人支付成功，剩余的1900人，付款的时候，提示没有库存。明明用户下单成功，支付的时候却提示没有货，这种体验太糟糕了。所以这种方案不太可取。另一种扣减库存的方案是下单就减库存，这种方案意味着用户下单成功，支付的时候一定有货，不会出现提示没有库存的现象，所以我会采用这种方案。如果用户下单之后10分钟没有支付，那么自动释放订单占有的 库存。

再有就是超卖现象，数据库层面，可以用乐观锁来解决，Redis层面，可以用事务来解决。

虽然秒杀的时候我们用上了数据库集群、Redis集群还有负载均衡，CDN加速等技术，但是面对海量的请求，我们还是要做好削峰和限流。比如在后台系统引入消息队列，拦截大量的请求。以上这些就是我对秒杀系统的设计了，如果没有说到的地方，还请您多指正。。



###2.商品秒杀活动很容易出现超售现象，你会怎么解决？

秒杀活动之前，我会先在Redis里面创建库存记录>然后秒杀程序首先watch一下redis里面的库存和成功抢购商品的用户列表记录，然后开启Redis事务，再扣减库存和记录成功秒杀商品的用户ID，最后提交Redis事务。如果事务提交的批处理指令，送达给Redis没有被其他秒杀操作插队，于是Redis的单线程就会执行当前事务提交的批处理命令，扣减库存不会出现超售现象。 



##订单管理面试题答案

###1.你能讲一下订单生成的流程吗？

- 我确实参与了订单模块的开发，对这项业务也了解一些。我们开发的微商城系统，拥有团购、优惠券、购物积分功能，所以用户在小程序上面下了订单，后台系统首先要做数据验证，然后还要做内容验证。假如有人用postman模拟小程序提交数据，有的数据能通过后台的正则表达式验证，但是逻辑上有问题。比如说提交过来的优惠券ID，在数据库里面根本就不存在。这样的订单是绝对不能生成的。所以我们要通过数据库，验证Ajax提交过来的数据是否逻辑有效。特别是优惠券和团购，都是有明确期限的，所以还要额外的去验证Ajax提交过来的优惠券和团购是否过期
- 接下来需要计算订单中的商品总价格，然后计算团购的减免金额，优惠券的减免金额，还有积分的减免金额。有了这些数据，后台程序就可以计算订单价格了，订单价格=商品总价格-团购减免金额-优惠券减免金额-积分减免金额。但是计算出来的订单价格还不是用户需要支付的实际价格。因为现在微商城有个包邮规则，用户购物满88元，可以包邮，所以后台程序要根据订单价格，计算出邮费是多少，满足包邮条件的时候，邮费就是0元，如果不满足包邮条件，邮费该多少钱，就是多少钱。订单的付款金额就是订单价格加上邮费，用户只要按照这个金额去付款就行了。
- 往数据库里面保存订单信息之后，后台程序还要去更新优惠券状态为已经使用，并且记录下来用户参加了哪项团购活动。最后是根据用户下单商品的数量，后台程序会扣减库存，然后跳转到支付页面等待用户支付，以上就是订单生成的全部流程。

###2.如果商品下架了，但是用户没有刷新页面就下单了，后台程序应该怎么处理？

- 生成订单的时候先要验证前台提交数据的格式，还要验证它的逻辑性有有效性。就拿下架商品来说把，后台程序生成订单之前要验证，商品是否存在，以及商品是否已经下架。如果商品已经下架，那么订单是不能生成的，我们给前台系统返回一个状态码，前台页面再告诉用户订单商品已经下架。

###3.扣减库存是什么时候？订单取消后，怎么恢复库存

- 这道问题你可以这样回答：我觉得最合理的扣减库存，应该是用户下单之后，而不是付款成功之后。这样能保证用户下单之后，如果付款成功，就一定能买到商品。如果下单不扣减库存，等到用户付款的时候，这件商品已经卖光了，对购物体验来说非常糟糕。另外，如果用户取消了订单，或者订单长时间未付款，后台系统会自动取消订单。不管什么原因，只要订单取消了，那么订单关联的商品就会自动释放库存，这样库存就恢复了。

###4.扣减库存怎么保证幂等性？

- 在高并发的情况下，扣减库存确实会出现逻辑上的错误。解决的办法有三种：
- 第一个方案是把数据库的事务级别设置成串行化执行，这种方法缺点是数据库所有的事务都要串行化执行，严重降低了数据库的并发性
- 第二个方案是对库存记录加行锁，但是加锁这种操作容易引起死锁，也不建议使用
- 第三个方案是给数据表加乐观锁，乐观锁不会锁住记录，所以可以保证并发性，但是乐观锁独有的版本号机制，保证了数据的修改必须要符合逻辑性。所以乐观锁是保证扣减库存具有幂等性的最佳方案。

###5.怎么保证订单号是不重复的？

- 现在我们知道了怎么生成全局唯一的订单号，那么这道问题就可以这样来回答：在我做的微商城项目里面，用了雪花算法生成订单号，雪花算法结合了时间戳、主机ID和随机数，生成订单号。但是在高并发的情况下，还是容易出现相同的订单号。因此说，可以增大订单号的长度，避免出现重复的订单号。

###6.你能说说订单号和流水号的区别么？他们是不是一回事儿？

- 订单号和流水号不是一回事儿，它们的用途不一样。
- 流水号是对内公开的，并且包含了一定的业务信息，比方说订单商品是固体还是液体，是不是易碎品，走空运还是陆运等等。因为我做的是微商城系统，没有那种大型的自动化仓库，所以在流水号里面没有包含货架信息。流水号的作用是工作人员或者机器人不需要查询数据库，就知道怎么发货，算是一种内部工作的指令集。
- 订单号是对外开放的，不需要包括详细的业务信息，只需要包括时间戳的就行了，能看出来是哪天下的订单即可。

###7.用户下的订单包含了收获地址，那么订单记录怎么引用收货人的地址？

- 订单记录不能引用收货地址ID。因为顾客修改了收货地址，那么他之前所有的订单，收货地址都同时更新了，这个绝对不行。以前的订单必须是以前的收货地址，不能受到地址更新的影响。所以在订单记录中，我不是引用的地址表的ID，而是把收货地址的数据保存在订单记录中，这样就不会受到用户修改地址的影响了。

### **8.你能说一下订单表是怎么设计的吗？**

- 在我做的微商城系统里面，订单模块用到两张数据表。一个是订单表，另外一个是订单商品表。因为一个订单可以包括多个商品，所以这两张表的关系是一对多的。订单的价格、邮费、实付金额、优惠券、团购、收货地址、发货信息、签收信息，这些信息保存在订单表里面。订单包含的商品信息、规格信息、价格，这样的信息保存在订单商品表里面。如果一个订单买了10个不同的商品，那么订单商品表里面就要存储这个订单的10种商品。这里不是直接引用SPU和SKU记录的ID，那样商家修改商品信息，订单里的商品也就变了。所以是把商品信息复制到订单商品表。

### **9.你做的电商项目，有没有用到订单拆分的功能？**

- 因为我做的是微商城系统，只有一个仓库，没有异地仓库，所以不需要对订单拆分。但是您说的订单拆分功能的思路我也略知一二。首先可以按照发货仓库来拆分订单，A仓库发货的商品，形成一个订单。B仓库发货的商品形成另一个订单，以此类推。其次，如果最近的仓库没有货，需要后台系统根据地理坐标，计算出最近的发货仓库，而且运费还要最便宜，让这样的仓库来发货，这是拆分订单的另一种思路。这就是我对订单拆分的粗浅理解了。

### **10.你能说说订单有几种取消形式吗？**

- 这道问题应该这样回答：电商系统中，取消订单的场景主要有三类：
- 第一类是由顾客发起的取消，用户在客户端取消订单
- 第二类是客服人员或者卖家代为取消订单。比如说用户下单支付以后，但是又后悔了，通过联络卖家或者客服人员，来取消订单。如果卖家尚未发货，是可以给顾客取消订单的
- 第三类是系统自动取消订单，比如说用户下单时候长时间没有付款，订单占用着商品的库存，这个不太好，所以超过规定的时间，系统可以自动取消订单，释放库存

## 用户权限管理面试题答案

### 1.**你做过的系统，权限是怎么管理的？**

- 我们用的是RBAC权限模型，然后把Shiro与SpringBoot整合到一起，用Shiro做权限验证

### 2.**什么是RBAC模型？**

- RBAC全称叫做基于角色的权限管理，首先要定义资源和操作，然后资源与操作结合在一起形成权限。接下来把权限分配给角色，这个是一对多的关系，一个角色可以对应多个权限，最后再把角色关联到用户，也是一对多的关系。总体说下来，需要创建资源表、操作表、权限表、角色表和用户表，一共五张表。



### 3.**如果让你手写一个Web过滤器验证权限，你会怎么写？**

- 首先我会在过滤器的doService方法里面写权限验证的代码，先排除掉登陆请求，这个是不需要权限拦截的。其他的请求都要被拦截，验证用户是否具备权限。我先定义一个properties文件，里面写上哪些url需要什么样的权限，然后在过滤器的init方法里加载这个配置文件。doService接收请求之后，先到Session中提取用户名，然后到数据库查询用户拥有的权限，接下来比较用户的权限跟请求url要求的权限是否匹配，如果匹配就转发请求，如果不匹配就返回响应，告诉给客户端，权限不够。

### **4.Shiro的anon和authc都代表什么意思？**

- anon代表url路径不需要权限验证；authc代表url路径需要权限验证。

### 5.**你认为编写Web方法的时候，用权限限定好，还是用角色限定好？**

- 我认为用权限限定更好。因为角色在系统中可以动态添加，但是权限通常不可以动态添加，所以在WEB方法上，用角色限定访问是不可取的。如果你允许A角色访问WEB方法，将来创建B角色，分配的权限也能访问这个WEB方法，难道还要修改Java代码，重新编译程序再上线吗？肯定不会。如果用了权限限定就没这个问题了，我在WEB方法上面限定了访问权限，不管创建多少个角色，只要他们具备相应权限，就能访问WEB方法，这种方式更好。

```java
//属于user角色
@RequiresRoles("user")
public String demo(){}
//必须同时属于user和admin角色
@RequiresRoles({"user","admin"})
public String demo(){}
//属于user或者admin之一;修改logical为OR 即可
@RequiresRoles(value={"user","admin"},logical=Logical.OR)
public String demo(){}
```

### 6.**如果一个WEB方法允许A权限或者B权限都可以访问，注解应该怎么写？**

```java
@RequiresPermissions(value={"A","B"},logical=Logical.OR)
public String demo(){}
```

### 7.**@RequiresAuthentication注解是什么意思？**

- 要求用户必须已经登录，但是并不验证权限

### 8.**在你的系统里，Shiro认证信息是怎么存放的？**

- 我们用了oauth2认证和JWT技术，所以认证信息以Token的形式存储在客户端

### 9.**你说一下什么是oauth2认证？**

- oauth2是一种开放式的授权方式，通常用于接入第三方应用。因为用户不信任第三方网站，也不想把用户名和密码存储在第三方网站上面，于是就需要一种把用户资源授权给第三方网站的机制，这就是oauth2。

### 10.**如果网站支持微信登陆，你能说一下微信登陆的oauth2流程么？**

- 用户从第三方网站进入微信登陆引导页面
- 用户手机扫描二维码，授权微信登陆
- 微信服务器把用户code返回给第三方网站
- 第三方网站把用户code和app唯一标识提供给微信服务器
- 微信服务器返回access_token和openid给第三方网站
- 第三方网站记录openid，并生成token令牌，返回浏览器
- 浏览器存储token令牌，完成oauth2认证

### **11.为什么不采用HttpSession存储令牌？**

- 因为分布式环境下，HttpSession不能再Tomcat之间共享，所以把令牌存放在客户端更好

### **12.你们用什么技术生成的令牌？**

- 我们用JWT生成令牌，以及验证令牌。我们把用户名或者openid，加密成令牌。将来用户提交令牌的时候，我们从其中可以解密获得用户名或者openid，接下来就可以去做权限验证了。

### **13.你们在客户端存放令牌，如果每次提交请求的时候，被抓包了，别人获取到Token，就能伪造客户端，发起请求，这个该怎么解决？**

- 可以用Https协议，这样就不会被抓包提取出Token了。

